<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <title>Chunking Test - Epub Parser</title>
    <script>this.ready=new Promise(function($){document.addEventListener('DOMContentLoaded',$,{once:true})})</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.1/jszip.min.js"></script>
    <script src="https://unpkg.com/epubjs@0.4.2/dist/epub.min.js"></script>
    <script src="../dist/paged.js"></script>

    <link rel="stylesheet" type="text/css" href="assets/styles/index.css">
    <!-- <link rel="stylesheet" type="text/css" href="assets/styles/mody-dick.css"> -->
</head>
<body>
  <script>
    ready.then(async function () {
      let preview = true;
      let url = new URL(window.location);
      let params = new URLSearchParams(url.search);
      for(var pair of params.entries()) {
        if(pair[0] === "preview") {
          preview = (pair[1] === "true");
        }
      }

      let pages = document.querySelector(".pages");
      let scale = ((window.innerWidth * .9 ) / pages.offsetWidth);

      pages.style.transform = `scale(${scale}) translate(${(window.innerWidth / 2) - ((pages.offsetWidth * scale / 2) ) }px, 0)`;

      let inputElement = document.getElementById("input");

      inputElement.addEventListener('change', function (e) {
        var file = e.target.files[0];
        if (window.FileReader) {
          var reader = new FileReader();
          reader.onload = openBook;
          reader.readAsArrayBuffer(file);

          let pages = document.querySelectorAll(".section");
          for (var i = 0; i < pages.length; i++) {
            pages[i].remove();
          }
        }
      });

      async function sections(spine) {
        let text = "";
        let pattern = /<body[^>]*>((.|[\n\r])*)<\/body>/im;
        let links = /<link[^>]*rel\s*=\s*["']\s*stylesheet\s*["'][^>]*>/im;

        for (let section of spine) {
          let href = section.href;
          let styles = "";
          let html = await fetch(href)
            .then((response) => {
              return response.text();
            }).then((t) => {
              let matches = pattern.exec(t);
              styles = links.exec(t);
              return matches && matches.length && matches[1];
            });
          text += "<paged-body>";

          // if (styles) {
          //   for (let i = 0; i < styles.length; i++) {
          //     text += styles[i];
          //   }
          // }

          text += html + "</paged-body>";
        }
        return text;
      }

      function addStyles(resources) {
        let head = document.querySelector("head");
        let styles = resources.filter((r) => {
          return r.type === "text/css";
        });
        for (let style of styles) {
          let link = document.createElement("link");
          link.rel = "stylesheet";
          link.type = "text/css";
          link.href = style.href;
          head.appendChild(link);
        }
      }

      function openBook(e){
        var bookData = e.target.result;

        let epub = ePub(bookData, {replacements: true} ).then((book) => {
          this.book = book;

          addStyles(this.book.resources)

          return sections(this.book.spine);
        }).then((text) => {
          let t0 = performance.now();
          let viewer = document.querySelector("#viewer");
          let flow = new Paged.Chunker(text, viewer, preview).then((flow) => {
            let t1 = performance.now();

            console.log("Rendering " + flow.total + " pages took " + (t1 - t0) + " milliseconds.");
          });

          epub = undefined;
        });
      }
    });
  </script>
<body>

  <div id="controls">
    <input type="file" id="input">
	</div>

  <div id="viewer"></div>
</body>
</html>
